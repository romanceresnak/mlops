name: Terraform Infrastructure Deploy

on: 
  workflow_call:
    inputs:
      TFAction:
        required: true
        type: string
      dply_environment:
        required: true
        type: string
      location:
        required: true
        type: string
      namespace:
        required: true
        type: string
      postfix:
        required: true
        type: string
      environment:
        required: true
        type: string
      enable_aml_computecluster:
        required: true
        type: boolean
      enable_monitoring:
        required: true
        type: boolean
      terraform_version:
        required: true
        type: string
      terraform_workingdir:
        required: true
        type: string
      terraform_st_location:
        required: true
        type: string
      terraform_st_storage_account:
        required: true
        type: string
      terraform_st_resource_group:
        required: true
        type: string
      terraform_st_container_name:
        required: true
        type: string
      terraform_st_key:
        required: true
        type: string
      terraform_plan_location:
        required: true
        type: string
      terraform_plan_vnet:
        required: true
        type: string
    secrets:
      azure_creds:
        required: true
      clientId:
        required: true
      clientSecret:
        required: true
      subscriptionId:
        required: true
      tenantId:
        required: true

jobs:
  deploy-terraform:
    runs-on: ubuntu-latest
    environment: ${{ inputs.dply_environment }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ inputs.terraform_version }}

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.azure_creds }}

    - name: Setup Backend Storage
      run: |
        # Create resource group if it doesn't exist
        az group create \
          --name ${{ inputs.terraform_st_resource_group }} \
          --location ${{ inputs.terraform_st_location }} || true
        
        # Create storage account if it doesn't exist
        az storage account create \
          --name ${{ inputs.terraform_st_storage_account }} \
          --resource-group ${{ inputs.terraform_st_resource_group }} \
          --location ${{ inputs.terraform_st_location }} \
          --sku Standard_LRS \
          --allow-blob-public-access false || true
        
        # Get storage key and create container
        STORAGE_KEY=$(az storage account keys list \
          --resource-group ${{ inputs.terraform_st_resource_group }} \
          --account-name ${{ inputs.terraform_st_storage_account }} \
          --query '[0].value' -o tsv)
        
        az storage container create \
          --name ${{ inputs.terraform_st_container_name }} \
          --account-name ${{ inputs.terraform_st_storage_account }} \
          --account-key "$STORAGE_KEY" || true

    - name: Terraform Init
      working-directory: ${{ inputs.terraform_workingdir }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ inputs.terraform_st_resource_group }}" \
          -backend-config="storage_account_name=${{ inputs.terraform_st_storage_account }}" \
          -backend-config="container_name=${{ inputs.terraform_st_container_name }}" \
          -backend-config="key=${{ inputs.terraform_st_key }}"
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}

    - name: Clean Orphaned Resources
      if: inputs.TFAction == 'apply'
      run: |
        echo "Cleaning up orphaned resources..."
        
        # Key Vault
        KV_NAME="kv-${{ inputs.namespace }}-${{ inputs.postfix }}${{ inputs.environment }}"
        
        # Check if Key Vault exists
        if az keyvault show --name "$KV_NAME" &>/dev/null; then
          echo "Found active Key Vault, checking if it's in our state..."
          # Try to import it or delete it
          cd ${{ inputs.terraform_workingdir }}
          if ! terraform state show module.key_vault.azurerm_key_vault.kv &>/dev/null; then
            echo "Key Vault exists but not in state, removing it..."
            az keyvault delete --name "$KV_NAME" --resource-group "rg-${{ inputs.namespace }}-${{ inputs.postfix }}${{ inputs.environment }}"
            sleep 30
            az keyvault purge --name "$KV_NAME" --location "${{ inputs.location }}"
          fi
        fi
        
        # Check for soft-deleted Key Vault
        if az keyvault show-deleted --name "$KV_NAME" --location "${{ inputs.location }}" &>/dev/null; then
          echo "Purging soft-deleted Key Vault..."
          az keyvault purge --name "$KV_NAME" --location "${{ inputs.location }}"
        fi
        
        # Storage Account
        ST_NAME="st${{ inputs.namespace }}${{ inputs.postfix }}${{ inputs.environment }}"
        if az storage account show --name "$ST_NAME" &>/dev/null; then
          echo "Found Storage Account, checking if it's in our state..."
          cd ${{ inputs.terraform_workingdir }}
          if ! terraform state show module.storage_account_aml.azurerm_storage_account.st &>/dev/null; then
            echo "Storage Account exists but not in state, removing it..."
            az storage account delete --name "$ST_NAME" --resource-group "rg-${{ inputs.namespace }}-${{ inputs.postfix }}${{ inputs.environment }}" --yes
          fi
        fi
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}
      continue-on-error: true

    - name: Terraform Refresh
      if: inputs.TFAction == 'apply'
      working-directory: ${{ inputs.terraform_workingdir }}
      run: |
        # Refresh state to sync with actual resources
        terraform refresh \
          -var="location=${{ inputs.location }}" \
          -var="prefix=${{ inputs.namespace }}" \
          -var="postfix=${{ inputs.postfix }}" \
          -var="environment=${{ inputs.environment }}" \
          -var="enable_aml_computecluster=${{ inputs.enable_aml_computecluster }}" \
          -var="enable_monitoring=${{ inputs.enable_monitoring }}" \
          -var="client_secret=${{ secrets.clientSecret }}" || true
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}

    - name: Terraform Plan
      if: inputs.TFAction == 'plan'
      working-directory: ${{ inputs.terraform_workingdir }}
      run: |
        terraform plan \
          -var="location=${{ inputs.location }}" \
          -var="prefix=${{ inputs.namespace }}" \
          -var="postfix=${{ inputs.postfix }}" \
          -var="environment=${{ inputs.environment }}" \
          -var="enable_aml_computecluster=${{ inputs.enable_aml_computecluster }}" \
          -var="enable_monitoring=${{ inputs.enable_monitoring }}" \
          -var="client_secret=${{ secrets.clientSecret }}"
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}

    - name: Terraform Apply
      if: inputs.TFAction == 'apply'
      working-directory: ${{ inputs.terraform_workingdir }}
      run: |
        terraform apply -auto-approve -lock=false \
          -var="location=${{ inputs.location }}" \
          -var="prefix=${{ inputs.namespace }}" \
          -var="postfix=${{ inputs.postfix }}" \
          -var="environment=${{ inputs.environment }}" \
          -var="enable_aml_computecluster=${{ inputs.enable_aml_computecluster }}" \
          -var="enable_monitoring=${{ inputs.enable_monitoring }}" \
          -var="client_secret=${{ secrets.clientSecret }}"
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}

    - name: Terraform Destroy
      if: inputs.TFAction == 'destroy'
      working-directory: ${{ inputs.terraform_workingdir }}
      run: |
        terraform destroy -auto-approve -lock=false \
          -var="location=${{ inputs.location }}" \
          -var="prefix=${{ inputs.namespace }}" \
          -var="postfix=${{ inputs.postfix }}" \
          -var="environment=${{ inputs.environment }}" \
          -var="enable_aml_computecluster=${{ inputs.enable_aml_computecluster }}" \
          -var="enable_monitoring=${{ inputs.enable_monitoring }}" \
          -var="client_secret=${{ secrets.clientSecret }}"
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}
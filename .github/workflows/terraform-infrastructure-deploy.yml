name: Terraform Infrastructure Deploy
 
on: 
  workflow_call:
    inputs:
      TFAction:
        required: true
        type: string
      dply_environment:
        required: true
        type: string
      location:
        required: true
        type: string
      namespace:
        required: true
        type: string
      postfix:
        required: true
        type: string
      environment:
        required: true
        type: string
      enable_aml_computecluster:
        required: true
        type: boolean
      enable_monitoring:
        required: true
        type: boolean
      terraform_version:
        required: true
        type: string
      terraform_workingdir:
        required: true
        type: string
      terraform_st_location:
        required: true
        type: string
      terraform_st_storage_account:
        required: true
        type: string
      terraform_st_resource_group:
        required: true
        type: string
      terraform_st_container_name:
        required: true
        type: string
      terraform_st_key:
        required: true
        type: string
      terraform_plan_location:
        required: true
        type: string
      terraform_plan_vnet:
        required: true
        type: string
    secrets:
      azure_creds:
        required: true
      clientId:
        required: true
      clientSecret:
        required: true
      subscriptionId:
        required: true
      tenantId:
        required: true

env:
  config_env: 'none'

jobs:
  deploy-terraform:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ inputs.terraform_version }}

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.azure_creds }}

    - name: Set Azure Subscription
      env:
        SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
      run: |
        echo "Setting subscription..."
        az account set --subscription "$SUBSCRIPTION_ID"
        echo "Current subscription:"
        az account show

    - name: Create Terraform State Storage
      env:
        SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        AZURE_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
      run: |
        # Set default subscription
        az account set --subscription "$SUBSCRIPTION_ID"
        az configure --defaults group=${{ inputs.terraform_st_resource_group }} location=${{ inputs.terraform_st_location }}
        
        # Create resource group
        echo "Creating resource group: ${{ inputs.terraform_st_resource_group }}"
        az group create \
          --name ${{ inputs.terraform_st_resource_group }} \
          --location ${{ inputs.terraform_st_location }} \
          --output json || echo "Resource group may already exist"
        
        # Create storage account
        echo "Creating storage account: ${{ inputs.terraform_st_storage_account }}"
        az storage account create \
          --resource-group ${{ inputs.terraform_st_resource_group }} \
          --name ${{ inputs.terraform_st_storage_account }} \
          --sku Standard_LRS \
          --encryption-services blob \
          --location ${{ inputs.terraform_st_location }} \
          --output json || echo "Storage account may already exist"
        
        # Wait for storage account to be ready
        echo "Waiting for storage account to be ready..."
        az storage account show \
          --name ${{ inputs.terraform_st_storage_account }} \
          --resource-group ${{ inputs.terraform_st_resource_group }} \
          --query "provisioningState" || true
        
        # Get storage account key
        echo "Getting storage account key..."
        STORAGE_KEY=$(az storage account keys list \
          --resource-group ${{ inputs.terraform_st_resource_group }} \
          --account-name ${{ inputs.terraform_st_storage_account }} \
          --query '[0].value' -o tsv)
        
        # Create container
        echo "Creating container: ${{ inputs.terraform_st_container_name }}"
        az storage container create \
          --name ${{ inputs.terraform_st_container_name }} \
          --account-name ${{ inputs.terraform_st_storage_account }} \
          --account-key "$STORAGE_KEY" \
          --output json || echo "Container may already exist"

    - name: Terraform Init
      working-directory: ${{ inputs.terraform_workingdir }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ inputs.terraform_st_resource_group }}" \
          -backend-config="storage_account_name=${{ inputs.terraform_st_storage_account }}" \
          -backend-config="container_name=${{ inputs.terraform_st_container_name }}" \
          -backend-config="key=${{ inputs.terraform_st_key }}"
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}

    - name: Terraform Plan
      if: inputs.TFAction == 'plan'
      working-directory: ${{ inputs.terraform_workingdir }}
      run: |
        terraform plan \
          -var="location=${{ inputs.location }}" \
          -var="prefix=${{ inputs.namespace }}" \
          -var="postfix=${{ inputs.postfix }}" \
          -var="env=${{ inputs.environment }}" \
          -var="enable_aml_computecluster=${{ inputs.enable_aml_computecluster }}" \
          -var="enable_monitoring=${{ inputs.enable_monitoring }}"
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}

    - name: Terraform Apply
      if: inputs.TFAction == 'apply'
      working-directory: ${{ inputs.terraform_workingdir }}
      run: |
        terraform apply -auto-approve \
          -var="location=${{ inputs.location }}" \
          -var="prefix=${{ inputs.namespace }}" \
          -var="postfix=${{ inputs.postfix }}" \
          -var="env=${{ inputs.environment }}" \
          -var="enable_aml_computecluster=${{ inputs.enable_aml_computecluster }}" \
          -var="enable_monitoring=${{ inputs.enable_monitoring }}"
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}
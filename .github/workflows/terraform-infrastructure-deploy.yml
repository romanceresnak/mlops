name: Terraform Infrastructure Deploy
 
on: 
  workflow_call:
    inputs:
      TFAction:
        required: true
        type: string
      dply_environment:
        required: true
        type: string
      location:
        required: true
        type: string
      namespace:
        required: true
        type: string
      postfix:
        required: true
        type: string
      environment:
        required: true
        type: string
      enable_aml_computecluster:
        required: true
        type: boolean
      enable_monitoring:
        required: true
        type: boolean
      terraform_version:
        required: true
        type: string
      terraform_workingdir:
        required: true
        type: string
      terraform_st_location:
        required: true
        type: string
      terraform_st_storage_account:
        required: true
        type: string
      terraform_st_resource_group:
        required: true
        type: string
      terraform_st_container_name:
        required: true
        type: string
      terraform_st_key:
        required: true
        type: string
      terraform_plan_location:
        required: true
        type: string
      terraform_plan_vnet:
        required: true
        type: string
    secrets:
      azure_creds:
        required: true
      clientId:
        required: true
      clientSecret:
        required: true
      subscriptionId:
        required: true
      tenantId:
        required: true

env:
  config_env: 'none'

jobs:
  deploy-terraform:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ inputs.terraform_version }}

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.azure_creds }}

    - name: Set Azure Subscription
      run: |
        az account set --subscription ${{ secrets.subscriptionId }}
        az account show

    - name: Create Terraform State Storage
      run: |
        # Create resource group if it doesn't exist
        az group create \
          --name ${{ inputs.terraform_st_resource_group }} \
          --location ${{ inputs.terraform_st_location }} \
          --output none || true
        
        # Create storage account if it doesn't exist
        az storage account create \
          --resource-group ${{ inputs.terraform_st_resource_group }} \
          --name ${{ inputs.terraform_st_storage_account }} \
          --sku Standard_LRS \
          --encryption-services blob \
          --output none || true
        
        # Create container if it doesn't exist
        az storage container create \
          --name ${{ inputs.terraform_st_container_name }} \
          --account-name ${{ inputs.terraform_st_storage_account }} \
          --output none || true

    - name: Terraform Init
      working-directory: ${{ inputs.terraform_workingdir }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ inputs.terraform_st_resource_group }}" \
          -backend-config="storage_account_name=${{ inputs.terraform_st_storage_account }}" \
          -backend-config="container_name=${{ inputs.terraform_st_container_name }}" \
          -backend-config="key=${{ inputs.terraform_st_key }}"
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}

    - name: Terraform Plan
      if: inputs.TFAction == 'plan'
      working-directory: ${{ inputs.terraform_workingdir }}
      run: |
        terraform plan \
          -var="location=${{ inputs.location }}" \
          -var="prefix=${{ inputs.namespace }}" \
          -var="postfix=${{ inputs.postfix }}" \
          -var="env=${{ inputs.environment }}" \
          -var="enable_aml_computecluster=${{ inputs.enable_aml_computecluster }}" \
          -var="enable_monitoring=${{ inputs.enable_monitoring }}"
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}

    - name: Terraform Apply
      if: inputs.TFAction == 'apply'
      working-directory: ${{ inputs.terraform_workingdir }}
      run: |
        terraform apply -auto-approve \
          -var="location=${{ inputs.location }}" \
          -var="prefix=${{ inputs.namespace }}" \
          -var="postfix=${{ inputs.postfix }}" \
          -var="env=${{ inputs.environment }}" \
          -var="enable_aml_computecluster=${{ inputs.enable_aml_computecluster }}" \
          -var="enable_monitoring=${{ inputs.enable_monitoring }}"
      env:
        ARM_CLIENT_ID: ${{ secrets.clientId }}
        ARM_CLIENT_SECRET: ${{ secrets.clientSecret }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.subscriptionId }}
        ARM_TENANT_ID: ${{ secrets.tenantId }}
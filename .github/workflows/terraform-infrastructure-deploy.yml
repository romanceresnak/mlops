name: Terraform Infrastructure Deploy

on:
  workflow_call:
    inputs:
      action:
        description: 'Terraform action: plan, apply, or destroy'
        required: true
        type: string
      environment:
        description: 'Deployment environment (e.g., prod, dev)'
        required: true
        type: string
      location:
        description: 'Azure region for all resources'
        required: true
        type: string
      namespace:
        description: 'Project namespace/prefix for resource naming'
        required: true
        type: string
      postfix:
        description: 'Unique postfix for resource naming'
        required: true
        type: string
      enable_aml_computecluster:
        required: true
        type: boolean
      enable_monitoring:
        required: true
        type: boolean
      terraform_version:
        required: false
        type: string
        default: '1.5.0'
      working_directory:
        required: false
        type: string
        default: './infrastructure'
      backend_resource_group:
        required: true
        type: string
      backend_storage_account:
        required: true
        type: string
      backend_container:
        required: false
        type: string
        default: 'default'
      backend_key:
        required: true
        type: string
    secrets:
      azure_creds:
        required: true
      arm_client_id:
        required: true
      arm_client_secret:
        required: true
      arm_subscription_id:
        required: true
      arm_tenant_id:
        required: true

env:
  ARM_CLIENT_ID: ${{ secrets.arm_client_id }}
  ARM_CLIENT_SECRET: ${{ secrets.arm_client_secret }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.arm_subscription_id }}
  ARM_TENANT_ID: ${{ secrets.arm_tenant_id }}
  TF_VAR_location: ${{ inputs.location }}
  TF_VAR_prefix: ${{ inputs.namespace }}
  TF_VAR_postfix: ${{ inputs.postfix }}
  TF_VAR_environment: ${{ inputs.environment }}
  TF_VAR_enable_aml_computecluster: ${{ inputs.enable_aml_computecluster }}
  TF_VAR_enable_monitoring: ${{ inputs.enable_monitoring }}
  TF_VAR_client_secret: ${{ secrets.arm_client_secret }}

jobs:
  terraform:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ inputs.terraform_version }}

    - name: Cache Terraform providers
      uses: actions/cache@v4
      with:
        path: |
          ~/.terraform.d/plugin-cache
          ${{ inputs.working_directory }}/.terraform
        key: terraform-${{ runner.os }}-${{ hashFiles('**/*.tf') }}
        restore-keys: terraform-${{ runner.os }}-

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.azure_creds }}

    - name: Terraform Init
      working-directory: ${{ inputs.working_directory }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${{ inputs.backend_resource_group }}" \
          -backend-config="storage_account_name=${{ inputs.backend_storage_account }}" \
          -backend-config="container_name=${{ inputs.backend_container }}" \
          -backend-config="key=${{ inputs.backend_key }}"

    - name: Terraform Format Check
      working-directory: ${{ inputs.working_directory }}
      run: terraform fmt -check -recursive
      continue-on-error: true

    - name: Terraform Validate
      working-directory: ${{ inputs.working_directory }}
      run: terraform validate

    - name: Terraform Plan
      if: inputs.action == 'plan' || inputs.action == 'apply'
      working-directory: ${{ inputs.working_directory }}
      id: plan
      run: |
        terraform plan -out=tfplan -no-color 2>&1 | tee plan_output.txt
        echo "## Terraform Plan" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        tail -50 plan_output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Terraform Apply
      if: inputs.action == 'apply'
      working-directory: ${{ inputs.working_directory }}
      run: |
        terraform apply -auto-approve tfplan
        echo "## Terraform Apply Complete" >> $GITHUB_STEP_SUMMARY
        echo "Resources deployed to **${{ inputs.location }}** in resource group **rg-${{ inputs.namespace }}-${{ inputs.postfix }}${{ inputs.environment }}**" >> $GITHUB_STEP_SUMMARY

    - name: Terraform Destroy
      if: inputs.action == 'destroy'
      working-directory: ${{ inputs.working_directory }}
      run: |
        terraform destroy -auto-approve
        echo "## Terraform Destroy Complete" >> $GITHUB_STEP_SUMMARY
        echo "All resources in **rg-${{ inputs.namespace }}-${{ inputs.postfix }}${{ inputs.environment }}** have been destroyed" >> $GITHUB_STEP_SUMMARY
